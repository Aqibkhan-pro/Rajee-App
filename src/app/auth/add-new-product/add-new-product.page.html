<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" class="back" (click)="prevStep()">
        <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>{{'offer_posting'| translate}}</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" class="back" (click)="prevStep()">
        {{'cancel' | translate}}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page-content">
  <div class="steps-wrap" [@stepAnim]="step">

    <!-- ===================== -->
    <!-- STEP 1 -->
    <!-- ===================== -->
    <div class="step-panel" *ngIf="step === 0">
      <ion-card class="step-card">
        <!-- Hidden file input for images -->
        <input #imgInput type="file" accept="image/*" multiple hidden (change)="onFilesPicked($event)" />

        <ion-item style="margin-top: 12px; --padding-start:0px" lines="none">
          <div class="images-row">
            <div class="pick-tile" (click)="pickMultipleImages(imgInput)">
              <ion-icon name="camera-outline"></ion-icon>
              <div class="pick-text">
                {{ 'add_image' | translate }}<br />
                ({{ pickedImages.length }}/{{ MAX_IMAGES }})
              </div>
            </div>

            <div class="picked-x" *ngIf="pickedImages.length">
              <div *ngFor="let img of pickedImages; let i = index" class="picked-card">
                <img [src]="img.dataUrl" class="picked-image" />
                <button type="button" class="remove-chip" (click)="removePickedImage(i)">
                  <ion-icon name="close"></ion-icon>
                </button>
              </div>
            </div>
          </div>
        </ion-item>

        <!-- Province / Location -->
        <ion-item style="--inner-padding-end: 0px; --padding-start:0px" lines="none">
          <div class="select_location clickable" (click)="openLocationModal()">
            <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
              <p class="location">{{ 'location' | translate }}</p>

              <div class="location-row">
                <p class="location_filled">
                  {{ locationDisplayText }}
                </p>
                <ion-icon class="chev" name="chevron-forward-outline"></ion-icon>
              </div>
            </div>
          </div>
        </ion-item>

        <!-- Subject -->
        <ion-item style="--inner-padding-end: 0px; --padding-start:0px" lines="none">
          <div class="select_location" style="margin-top: 1px;">
            <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
              <p class="location">{{ 'offer_subject' | translate }}</p>
              <ion-input [(ngModel)]="model.subject" [placeholder]="'offer_subject' | translate"
                class="change_subject"></ion-input>
            </div>
          </div>
        </ion-item>

        <!-- Section -->
        <ion-item style="--inner-padding-end: 0px; --padding-start:0px" lines="none">
          <div class="select_location" style="margin-top: 1px;">
            <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
              <p class="location">{{ 'section' | translate }}</p>

              <div class="location-row">
                <!-- ✅ Click on text/row to open modal -->
                <p class="location_filled clickable" (click)="openCategoryModal()">
                  {{ carDisplayText }}
                </p>

                <!-- ✅ Click on icon to reset and re-pick -->
                <ion-icon class="chev clickable" name="create-outline"
                  (click)="$event.stopPropagation(); onEditCategory()"></ion-icon>
              </div>
            </div>
          </div>
        </ion-item>

        <div class="step-actions">
          <ion-button expand="block" mode="ios" (click)="nextStep()" class="next_button">
            {{ 'next' | translate }}
          </ion-button>
        </div>
      </ion-card>
    </div>

    <!-- ===================== -->
    <!-- STEP 2 -->
    <!-- ===================== -->
    <div class="step-panel" *ngIf="step === 1 && isCarsSelected()">
      <ion-card class="step-card p-10" style="padding-bottom: 100px; overflow-y: auto;">

        <!-- Sell / Waiver -->
        <ion-label class="title_sell ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">{{
          'sell_or_waiver' | translate }}</ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-segment [(ngModel)]="model.dealType" mode="ios">
            <ion-segment-button value="sell" style="--border-radius: 12px 0px 0px 12px;">
              <ion-label>{{ 'deal_type_sell' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="waiver" style="--border-radius: 0px 12px 12px 0px;">
              <ion-label>{{ 'deal_type_waiver' | translate }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <!-- Condition -->
        <ion-label class="title_sell mt10 ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">{{
          'car_condition' | translate }}</ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-segment [(ngModel)]="model.condition" mode="ios">
            <ion-segment-button value="new" style="--border-radius: 12px 0px 0px 12px;">
              <ion-label>{{ 'condition_new' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="used" style="--border-radius: 0px 0px 0px 0px;">
              <ion-label>{{ 'condition_used' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="damaged" style="--border-radius: 0px 12px 12px 0px;">
              <ion-label>{{ 'condition_damaged' | translate }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <!-- Gear -->
        <ion-label class="title_sell mt10 ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">{{
          'gear_type' | translate }}</ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-segment [(ngModel)]="model.gearType" mode="ios">
            <ion-segment-button value="manual" style="--border-radius: 12px 0px 0px 12px;">
              <ion-label>{{ 'gear_manual' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="automatic" style="--border-radius: 0px 12px 12px 0px;">
              <ion-label>{{ 'gear_automatic' | translate }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <!-- Fuel -->
        <ion-label class="title_sell mt10 ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">{{
          'fuel_type' | translate }}</ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-segment [(ngModel)]="model.fuelType" mode="ios">
            <ion-segment-button value="gasoline" style="--border-radius: 12px 0px 0px 12px;">
              <ion-label>{{ 'fuel_gasoline' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="diesel" style="--border-radius: 0px 0px 0px 0px;">
              <ion-label>{{ 'fuel_diesel' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="hybrid" style="--border-radius: 0px 12px 12px 0px;">
              <ion-label>{{ 'fuel_hybrid' | translate }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <!-- Mileage -->
        <ion-label class="title_sell mt10 ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">
          {{ 'mileage_km' | translate:{ value: model.mileage } }}
        </ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-range [(ngModel)]="model.mileage" [min]="0" [max]="100" [step]="1" [pin]="true"
            (ionChange)="onMileageChange($event)"></ion-range>
        </ion-item>

        <!-- 4WD -->
        <ion-label class="title_sell mt10 ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">{{
          'is_4wd' | translate }}</ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-segment [(ngModel)]="model.is4wd" mode="ios">
            <ion-segment-button value="yes" style="--border-radius: 12px 0px 0px 12px;">
              <ion-label>{{ 'yes' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="no" style="--border-radius: 0px 12px 12px 0px;">
              <ion-label>{{ 'no' | translate }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <!-- Car Class -->
        <ion-label class="title_sell mt10 ionlabel" [ngClass]="selectedLanguage == 'ar' ? 'j_right' : 'j_left'">{{
          'car_class' | translate }}</ion-label>
        <ion-item lines="full" class="sell_or_waiver">
          <ion-chip *ngFor="let c of carClassOptions" (click)="toggleCarClass(c)" [outline]="!isCarClassSelected(c)">
            {{ ('car_class_' + c) | translate }}
          </ion-chip>
        </ion-item>

        <div class="step-actions">
          <ion-button expand="block" mode="ios" (click)="nextStep()" class="next_button">
            {{ 'next' | translate }}
          </ion-button>
        </div>

      </ion-card>
    </div>

    <!-- ===================== -->
    <!-- STEP 3 -->
    <!-- ===================== -->
    <div class="step-panel" *ngIf="step === 2">
      <ion-card class="step-card p-10" style="padding-bottom: 100px; overflow-y: auto;">

        <ion-label class="title_sell">Review Details</ion-label>

        <!-- ✅ Readonly Preview: Location -->
        <div class="select_location readonly-box">
          <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
            <p class="location">{{ 'location' | translate }}</p>
            <div class="location-row">
              <p class="location_filled">{{ locationDisplayText }}</p>
            </div>
          </div>
        </div>

        <!-- ✅ Readonly Preview: Offer Subject -->
        <div class="select_location readonly-box">
          <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
            <p class="location">{{ 'offer_subject' | translate }}</p>
            <div class="location-row">
              <p class="location_filled">
                {{ model.subject?.trim() ? model.subject : '-' }}
              </p>
            </div>
          </div>
        </div>

        <!-- ✅ Readonly Preview: Section -->
        <div class="select_location readonly-box">
          <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
            <p class="location">{{ 'section' | translate }}</p>
            <div class="location-row">
              <p class="location_filled">{{ carDisplayText }}</p>
            </div>
          </div>
        </div>


        <!-- ✅ Readonly Preview: Section -->
        <div class="select_location readonly-box">
          <div class="sub_select_location" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
            <p class="location">{{ 'enter_description' | translate }}</p>
            <div class="location-row">
              <ion-textarea [(ngModel)]="model.extraInfo" autoGrow="true"
                [placeholder]="'description_label' | translate " style="min-height: 140px;"></ion-textarea>
            </div>
          </div>
        </div>


        <!-- ✅ Price -->
        <ion-item lines="full" class="sell_or_waiver" style="margin-top: 20px;">
          <ion-text style="color: var(--text-black);">Price</ion-text>

          <ion-input class="price" fill="outline" type="number" inputmode="numeric" [(ngModel)]="model.price"
            placeholder="xxxxxxx" [disabled]="disablePrice">
            <ion-icon slot="end" name="cash"></ion-icon>
          </ion-input>

          <ion-toggle slot="end" mode="ios" [checked]="disablePrice" (ionChange)="onPriceToggle($event)"
            style="--track-background:#C7C7C7"></ion-toggle>
        </ion-item>


        <!-- ✅ Phone -->
        <ion-item lines="full" class="sell_or_waiver">
          <ion-text style="color: var(--text-black);">Phone</ion-text>

          <ion-input class="price" fill="outline" type="tel" inputmode="tel" [(ngModel)]="model.phone"
            placeholder="xx xxx-xxxxxxx" [disabled]="disablePhone">
            <ion-icon slot="end" name="call"></ion-icon>
          </ion-input>

          <ion-toggle slot="end" mode="ios" [checked]="disablePhone" (ionChange)="onPhoneToggle($event)"
            style="--track-background:#C7C7C7"></ion-toggle>
        </ion-item>



        <div class="step-actions">
          <ion-button expand="block" mode="ios" (click)="save()" class="next_button">
            Save
          </ion-button>
        </div>
      </ion-card>
    </div>

  </div>
</ion-content>