<ion-header class="ion-no-border">
  <ion-toolbar>

    <ion-buttons [slot]="selectedLanguage == 'en' ? 'start' : 'end'">
      <ion-menu-button menu="homeMenu"></ion-menu-button>
    </ion-buttons>

    <div class="top-search-wrap" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
      <ion-searchbar
        #searchbar
        class="top-search custom-search"
        [placeholder]="'search_on_rajee' | translate"
        (ionInput)="onSearch($event)"
        mode="ios">
      </ion-searchbar>
    </div>

    <ion-buttons [slot]="selectedLanguage !== 'en' ? 'start' : 'end'">
      <ion-button fill="clear" (click)="toggleLayout()"
        style="color: var(--secondary-color); --background: var(--primary-color);">
        <ion-icon [name]="isGrid ? 'list' : 'grid'" style="color: var(--button-color) !important"></ion-icon>
      </ion-button>
    </ion-buttons>

    <!-- ✅ Non-blocking loading indicator -->
    <ion-progress-bar *ngIf="pageLoading" type="indeterminate"></ion-progress-bar>
  </ion-toolbar>
</ion-header>

<ion-content id="main-content" [scrollY]="false">

  <div class="home-wrapper">

    <div class="home-top">

      <!-- ✅ STORIES -->
      <div class="stories-wrapper" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
        <div class="stories-header">
          <div class="stories-title">
            {{ selectedLanguage=='en' ? 'Stories' : 'القصص' }}
          </div>

          <ion-button fill="clear" class="stories-toggle-btn" (click)="toggleStories()">
            <ion-icon
              [name]="storiesCollapsed ? 'chevron-down-outline' : 'chevron-up-outline'"
              class="arrow-icon"
              [class.rotate]="!storiesCollapsed">
            </ion-icon>
          </ion-button>
        </div>

        <div class="stories-body" [class.collapsed]="storiesCollapsed">
          <div class="stories-scroll">

            <!-- Add Story -->
            <div class="story-item" (click)="openAddStoryModal()">
              <div class="story-ring add-story">
                <div class="story-avatar">
                  <div class="story-initial">
                    {{ getInitial(currentUserName) }}
                  </div>

                  <div class="plus-badge">
                    <ion-icon name="add"></ion-icon>
                  </div>
                </div>
              </div>

              <div class="story-name">
                {{ selectedLanguage=='en' ? 'Your Story' : 'قصتك' }}
              </div>
            </div>

            <!-- ✅ Story Skeleton ONLY when no cached stories -->
            <ng-container *ngIf="storiesLoading && stories.length === 0">
              <div class="story-item" *ngFor="let _ of skeletonStories">
                <div class="story-ring story-skel">
                  <div class="story-avatar">
                    <ion-skeleton-text animated style="width:58px;height:58px;border-radius:50%"></ion-skeleton-text>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Story List -->
            <div class="story-item" *ngFor="let s of stories; trackBy: trackByStoryId" (click)="openStoryViewer(s)">
              <div class="story-ring" [class.seen]="s.seen">
                <div class="story-avatar">
                  <img [src]="s?.image" alt="Story" *ngIf="s?.image" loading="lazy">
                  <div class="story-initial" *ngIf="!s?.image">
                    {{ getInitial(s.userName) }}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ✅ Category Chips -->
      <div class="category-chips-container" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
        <ion-chip
          *ngFor="let category of categories; trackBy: trackByCategoryKey"
          [color]="category.selected ? 'primary' : 'medium'"
          [outline]="!category.selected"
          (click)="onCategorySelect(category)">
          <ion-icon [name]="category.icon"></ion-icon>
          <ion-label style="margin-top: 4px;">
            {{ selectedLanguage == 'en' ? category.en : category.ar }}
          </ion-label>
        </ion-chip>
      </div>

      <!-- ✅ Sub Category -->
      <div class="subcat-bar" *ngIf="selectedSectionKey !== 'all'" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
        <ion-select
          interface="popover"
          class="subcat-select"
          [value]="selectedSubCategoryKey"
          (ionChange)="onSubCategorySelect($event.detail.value)"
          [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">

          <ion-select-option value="all">
            {{ selectedLanguage=='en' ? 'All' : 'الكل' }}
          </ion-select-option>

          <ion-select-option *ngFor="let sc of subCategoryOptions; trackBy: trackBySubKey" [value]="sc.key">
            {{ selectedLanguage === 'en' ? sc.en : sc.ar }}
          </ion-select-option>

        </ion-select>
      </div>
    </div>

    <!-- ✅ LIST AREA (scroll only this) -->
    <div class="home-list" #listScroll (scroll)="onListScroll()">
      <div class="card-container" [class.grid-view]="isGrid">

        <!-- ✅ Skeleton cards ONLY when no cached products -->
        <ng-container *ngIf="productsLoading && items.length === 0">
          <ion-card *ngFor="let _ of skeletonCards" mode="ios">
            <div class="skel-card" [class.skel-grid]="isGrid">
              <ion-skeleton-text animated class="skel-img"></ion-skeleton-text>
              <div class="skel-body">
                <ion-skeleton-text animated class="skel-line w80"></ion-skeleton-text>
                <ion-skeleton-text animated class="skel-line w60"></ion-skeleton-text>
                <ion-skeleton-text animated class="skel-line w40"></ion-skeleton-text>
              </div>
            </div>
          </ion-card>
        </ng-container>

        <!-- ✅ Real cards -->
        <ion-card *ngFor="let item of filteredItems; trackBy: trackByItemId" mode="ios">

          <!-- LIST VIEW -->
          <ion-item class="card-item" lines="none" (click)="onCardClick(item)" *ngIf="!isGrid">
            <img
              [src]="(item?.images?.[0] || item?.image || 'assets/images/img/usr.png')"
              [alt]="item?.title"
              class="card-image"
              loading="lazy" />

            <div class="card-details">
              <div class="card-title"
                   [attr.dir]="(item.title | isArabic) ? 'rtl' : 'ltr'"
                   [style.text-align]="(item.title | isArabic) ? 'right' : 'left'">
                {{ item.title }}
              </div>

              <div class="card-row">
                <div class="price-pill">
                  <ion-icon name="pricetag-outline"></ion-icon>
                  <span style="margin-top: 6px;">{{ item.price ?? 'N/A' }}</span>
                </div>

                <div class="meta">
                  <ion-icon name="time-outline"></ion-icon>
                  <span style="margin-top: 4px;">{{ item.time | timeAgo: nowTs : selectedLanguage }}</span>
                </div>
              </div>

              <div class="card-row">
                <div class="meta">
                  <ion-icon name="location-outline"></ion-icon>
                  <span *ngIf="item?.provinceName">
                    {{ selectedLanguage === 'en' ? item.provinceName?.en : item.provinceName?.ar }}
                  </span>
                  <span *ngIf="!item?.provinceName">N/A</span>
                </div>

                <div class="user">
                  <span class="initial-circle">{{ item.user?.name?.charAt(0) || '?' }}</span>
                  <span class="user-name" style="color:var(--text-black)">{{ item.user?.name || 'User' }}</span>
                </div>
              </div>
            </div>
          </ion-item>

          <!-- GRID VIEW -->
          <div *ngIf="isGrid" (click)="onCardClick(item)">
            <img
              [src]="(item?.images?.[0] || item?.image || 'assets/images/img/usr.png')"
              [alt]="item?.title"
              class="card-image"
              loading="lazy" />

            <div class="card-title"
                 style="margin: 8px; font-size: 13px;"
                 [attr.dir]="(item.title | isArabic) ? 'rtl' : 'ltr'"
                 [style.text-align]="(item.title | isArabic) ? 'right' : 'left'">
              {{ item.title }}
            </div>

            <div class="card-row" style="margin: 0px 5px 5px;">
              <div class="price-pill" style="padding: 6px 10px;">
                <ion-icon name="pricetag-outline"></ion-icon>
                <span>{{ item.price ?? 'N/A' }}</span>
              </div>

              <div class="meta">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ item.time | timeAgo: nowTs : selectedLanguage }}</span>
              </div>
            </div>
          </div>

        </ion-card>

        <!-- ✅ Empty State (only after load) -->
        <div *ngIf="!productsLoading && filteredItems.length === 0" class="empty-state">
          <ion-icon name="basket-outline" size="large"></ion-icon>
          <p>{{ 'no_items' | translate }}</p>
        </div>

      </div>

      <!-- ✅ Load more button -->
      <div class="load-more-wrap" *ngIf="!productsLoading && hasMore">
        <ion-button expand="block" class="load-more-btn" [disabled]="loadingMore" (click)="loadMoreProducts()">
          <ng-container *ngIf="!loadingMore">
            {{ selectedLanguage=='en' ? 'Load more' : 'تحميل المزيد' }}
          </ng-container>
          <ng-container *ngIf="loadingMore">
            <ion-spinner name="crescent" slot="start"></ion-spinner>
            {{ selectedLanguage=='en' ? 'Loading…' : 'جارٍ التحميل…' }}
          </ng-container>
        </ion-button>
      </div>

    </div>
  </div>

  <!-- ✅ Add Story Modal -->
  <ion-modal [isOpen]="isAddStoryOpen" (didDismiss)="closeAddStoryModal()" mode="ios">
    <ng-template>
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-title>{{ selectedLanguage=='en' ? 'Add Story' : 'إضافة قصة' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddStoryModal()"
              style="--color: var(--button-color); --background: var(--primary-color);">
              {{ selectedLanguage=='en' ? 'Close' : 'إغلاق' }}
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding story-modal">
        <div class="story-head" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
          <div class="story-head-title">
            {{ selectedLanguage=='en' ? 'New Story' : 'قصة جديدة' }}
          </div>
          <div class="story-head-sub">
            {{ selectedLanguage=='en' ? 'Add a photo and caption' : 'أضف صورة ووصف' }}
          </div>
        </div>

        <button type="button" class="story-pick-box" (click)="pickStoryImage()">
          <ng-container *ngIf="!pickedStoryPreview">
            <div class="story-pick-icon">
              <ion-icon name="images-outline"></ion-icon>
            </div>

            <div class="story-pick-text">
              <div class="t1">
                {{ selectedLanguage=='en' ? 'Tap to pick a photo' : 'اضغط لاختيار صورة' }}
              </div>
              <div class="t2">
                {{ selectedLanguage=='en' ? 'From your gallery' : 'من المعرض' }}
              </div>
            </div>
          </ng-container>

          <img *ngIf="pickedStoryPreview" [src]="pickedStoryPreview" class="story-preview" />
          <div class="story-change-badge" *ngIf="pickedStoryPreview">
            <ion-icon name="create-outline"></ion-icon>
            <span>{{ selectedLanguage=='en' ? 'Change' : 'تغيير' }}</span>
          </div>
        </button>

        <div class="field-card mt12" [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'">
          <ion-label class="field-label">
            {{ selectedLanguage=='en' ? 'Caption (optional)' : 'وصف (اختياري)' }}
          </ion-label>

          <ion-textarea
            class="field-textarea"
            [(ngModel)]="newStoryCaption"
            autoGrow="true"
            rows="3"
            placeholder="{{ selectedLanguage=='en' ? 'Write something…' : 'اكتب شيئاً…' }}">
          </ion-textarea>

          <div class="hint-row">
            <span class="hint">{{ selectedLanguage=='en' ? 'Tip: keep it short' : 'نصيحة: اجعل الوصف قصيراً' }}</span>
            <span class="count">{{ (newStoryCaption?.length || 0) }}/120</span>
          </div>
        </div>

        <div class="story-actions mt16">
          <ion-button expand="block" class="story-submit" [disabled]="uploadingStory" (click)="addStory()">
            <ng-container *ngIf="!uploadingStory">
              <ion-icon name="paper-plane-outline" slot="start"></ion-icon>
              {{ selectedLanguage=='en' ? 'Post Story' : 'نشر القصة' }}
            </ng-container>

            <ng-container *ngIf="uploadingStory">
              <ion-spinner name="crescent" slot="start"></ion-spinner>
              {{ selectedLanguage=='en' ? 'Uploading...' : 'جارٍ الرفع...' }}
            </ng-container>
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- ✅ Story Viewer Modal -->
  <ion-modal [isOpen]="isStoryViewerOpen" (didDismiss)="closeStoryViewer()" mode="ios">
    <ng-template>
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-title>{{ activeStory?.userName }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeStoryViewer()"
              style="--color: var(--button-color); --background: var(--primary-color);">
              {{ selectedLanguage=='en' ? 'Close' : 'إغلاق' }}
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="story-viewer">
        <div class="story-viewer-inner">
          <img [src]="activeStory?.image" class="story-full-image" />
          <div class="story-caption" *ngIf="activeStory?.caption">
            {{ activeStory?.caption }}
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>